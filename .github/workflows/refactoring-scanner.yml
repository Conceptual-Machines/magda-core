name: Refactoring Opportunities Scanner

on:
  # Run bi-weekly on the 1st and 15th at 10:00 AM UTC
  schedule:
    - cron: '0 10 1,15 * *'
  # Allow manual triggering
  workflow_dispatch:

# Ensure only one scan runs at a time
concurrency:
  group: refactoring-scanner
  cancel-in-progress: false

jobs:
  find-refactoring-opportunities:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: false

    - name: Install Python and dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install lizard

    - name: Analyze code complexity
      id: complexity
      run: |
        echo "Analyzing code complexity..."
        
        # Use lizard to find complex functions (C++ compatible)
        echo "=== High Complexity Functions (Cyclomatic Complexity > 10) ===" > refactoring-report.txt
        lizard magda/ tests/ -l cpp -C 10 >> refactoring-report.txt || echo "None found" >> refactoring-report.txt
        
        # Count high-complexity items (CCN > 10)
        COMPLEX_COUNT=$(lizard magda/ tests/ -l cpp -C 10 2>/dev/null | grep -c "^[[:space:]]*[0-9]" || echo "0")
        echo "complex_count=$COMPLEX_COUNT" >> $GITHUB_OUTPUT
        
        echo "" >> refactoring-report.txt
        echo "Total high-complexity functions/methods: $COMPLEX_COUNT" >> refactoring-report.txt

    - name: Find duplicate code candidates
      run: |
        echo "" >> refactoring-report.txt
        echo "=== Potential Code Duplication ===" >> refactoring-report.txt
        
        # Look for similar function names that might indicate duplication
        echo "Functions with similar names (potential duplication):" >> refactoring-report.txt
        find magda/ tests/ \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" \) -exec grep -h "^[a-zA-Z_].*::" {} \; | \
          sort | uniq -c | sort -rn | head -20 >> refactoring-report.txt || true

    - name: Find large files
      run: |
        echo "" >> refactoring-report.txt
        echo "=== Large Files (>500 lines, candidates for splitting) ===" >> refactoring-report.txt
        {
          find magda/ tests/ \( -name "*.cpp" -o -name "*.hpp" \) | while read -r file; do
            LINES=$(wc -l < "$file")
            if [ "$LINES" -gt 500 ]; then
              echo "$file: $LINES lines"
            fi
          done
        } | sort -t: -k2 -rn >> refactoring-report.txt

    - name: Detect tight coupling
      run: |
        echo "" >> refactoring-report.txt
        echo "=== Tight Coupling Indicators ===" >> refactoring-report.txt
        
        # Files that include many other project headers
        echo "Files with many internal includes (>10):" >> refactoring-report.txt
        {
          find magda/ \( -name "*.cpp" -o -name "*.hpp" \) | while read -r file; do
            INTERNAL_INCLUDES=$(grep -c "#include.*magda" "$file" 2>/dev/null || echo "0")
            if [ "$INTERNAL_INCLUDES" -gt 10 ]; then
              echo "$file: $INTERNAL_INCLUDES internal includes"
            fi
          done
        } | sort -t: -k2 -rn >> refactoring-report.txt

    - name: Find unused includes
      run: |
        echo "" >> refactoring-report.txt
        echo "=== Include Statistics ===" >> refactoring-report.txt
        echo "Note: Run scripts/find-unused-includes.py for detailed unused include analysis" >> refactoring-report.txt
        
        # Count total includes for reference
        TOTAL_INCLUDES=$(find magda/ tests/ \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" \) | \
          xargs grep -c "#include" | awk -F: '{sum+=$2} END {print sum}')
        echo "Total #include statements: $TOTAL_INCLUDES" >> refactoring-report.txt

    - name: Check for magic numbers
      run: |
        echo "" >> refactoring-report.txt
        echo "=== Magic Numbers (should be named constants) ===" >> refactoring-report.txt
        
        # Find numeric literals that aren't 0, 1, 2, -1
        grep -r "[^a-zA-Z0-9_][0-9]\{2,\}[^a-zA-Z0-9_]" magda/ --include="*.cpp" -n | \
          grep -v "\.0\|1000\|2000\|255" | head -30 >> refactoring-report.txt || echo "Sample found" >> refactoring-report.txt

    - name: Identify god objects
      run: |
        echo "" >> refactoring-report.txt
        echo "=== Potential God Objects (classes with many public methods) ===" >> refactoring-report.txt
        
        # Count public method declarations in header files (simplified heuristic)
        {
          find magda/ -name "*.hpp" | while read -r file; do
            CLASS_NAME=$(grep "^class\|^struct" "$file" | head -1 | awk '{print $2}' | sed 's/[:{]//g')
            if [ -n "$CLASS_NAME" ]; then
              # Count lines that look like method declarations (public section)
              METHOD_COUNT=$(awk '/^public:/,/^(private:|protected:)/ {if (/^\s*[a-zA-Z_][a-zA-Z0-9_]*\s*\(/) count++} END {print count+0}' "$file")
              if [ "$METHOD_COUNT" -gt 20 ]; then
                echo "$file ($CLASS_NAME): ~$METHOD_COUNT public methods"
              fi
            fi
          done
        } | sort -t: -k2 -rn | head -10 >> refactoring-report.txt

    - name: Upload refactoring report
      uses: actions/upload-artifact@v4
      with:
        name: refactoring-opportunities-report
        path: refactoring-report.txt
        retention-days: 30

    - name: Create refactoring issue
      if: steps.complexity.outputs.complex_count > 3
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('refactoring-report.txt', 'utf8');
          
          const issueBody = `## Refactoring Opportunities Report
          
          This issue was automatically created by the refactoring scanner workflow.
          
          ### Summary
          - **High-complexity functions**: ${{ steps.complexity.outputs.complex_count }}
          - **Analysis date**: ${new Date().toISOString().split('T')[0]}
          
          ### Detailed Findings
          
          <details>
          <summary>Click to expand full report</summary>
          
          \`\`\`
          ${report}
          \`\`\`
          
          </details>
          
          ### Recommended Actions
          
          1. **High Complexity**: Break down complex functions (cyclomatic complexity > 10)
          2. **Large Files**: Consider splitting files over 500 lines into smaller modules
          3. **Tight Coupling**: Review files with many internal dependencies
          4. **Magic Numbers**: Replace literal numbers with named constants
          5. **God Objects**: Consider splitting classes with 20+ methods
          
          ### Next Steps
          
          - Review high-priority items
          - Create separate issues for specific refactoring tasks
          - Schedule refactoring in upcoming sprints
          
          **Note**: This is an automated report. Use your judgment to prioritize.
          `;
          
          // Check if a recent refactoring issue exists
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['refactoring', 'automated'],
            state: 'open',
            since: thirtyDaysAgo.toISOString()
          });
          
          if (issues.data.length === 0) {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Automated] Refactoring Opportunities - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['refactoring', 'automated', 'technical-debt']
            });
            console.log('Created new refactoring issue');
          } else {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `## Updated Scan - ${new Date().toISOString()}\n\n${issueBody}`
            });
            console.log('Updated existing refactoring issue');
          }

    - name: Summary
      run: |
        echo "## Refactoring Analysis Complete ðŸ”" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **High-complexity functions**: ${{ steps.complexity.outputs.complex_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Review the full report in workflow artifacts for detailed findings." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        COMPLEX_COUNT="${{ steps.complexity.outputs.complex_count }}"
        if [ "${COMPLEX_COUNT:-0}" -gt 3 ]; then
          echo "âš ï¸ **Action needed**: GitHub issue created for high-priority refactoring opportunities." >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Code complexity is within acceptable limits." >> $GITHUB_STEP_SUMMARY
        fi
