name: Secret Scanning Prevention

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  scan-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection

    - name: Install gitleaks
      run: |
        wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
        tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
        sudo mv gitleaks /usr/local/bin/
        gitleaks version

    - name: Run gitleaks scan
      run: |
        echo "Scanning for secrets in the repository..."
        gitleaks detect --source . --verbose --no-git --report-format sarif --report-path gitleaks-report.sarif || SCAN_FAILED=true
        
        if [ "$SCAN_FAILED" = "true" ]; then
          echo "❌ Secret scanning detected potential secrets!"
          echo ""
          echo "⚠️  CRITICAL: Potential secrets or credentials detected in the code."
          echo ""
          echo "If these are false positives, you can:"
          echo "1. Add them to .gitleaksignore file"
          echo "2. Use inline comments: # gitleaks:allow"
          echo ""
          echo "If these are real secrets:"
          echo "1. DO NOT commit this code"
          echo "2. Rotate/revoke the exposed credentials immediately"
          echo "3. Remove secrets from code and use environment variables"
          echo "4. Review git history and remove secrets from past commits"
          echo ""
          exit 1
        else
          echo "✅ No secrets detected!"
        fi

    - name: Upload SARIF results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gitleaks-report.sarif
        category: secrets

    - name: Summary
      if: success()
      run: |
        echo "## ✅ Secret Scan Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "No secrets or credentials detected in the repository." >> $GITHUB_STEP_SUMMARY
