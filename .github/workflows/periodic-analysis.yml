name: Periodic Code Analysis

on:
  # Run weekly on Mondays at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual triggering
  workflow_dispatch:

# Ensure only one analysis runs at a time
concurrency:
  group: periodic-analysis
  cancel-in-progress: false

jobs:
  analyze-codebase:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: false  # No need for submodules for analysis

    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc grep ripgrep

    - name: Collect codebase metrics
      id: metrics
      run: |
        echo "Collecting codebase metrics..."
        
        # Count lines of code
        cloc --json magda/ tests/ > cloc-report.json
        
        # Find TODO/FIXME comments
        echo "=== TODOs and FIXMEs ===" > analysis-report.txt
        grep -r "TODO\|FIXME" magda/ tests/ --include="*.cpp" --include="*.hpp" --include="*.h" -n >> analysis-report.txt || true
        
        # Count them
        TODO_COUNT=$(grep -r "TODO" magda/ tests/ --include="*.cpp" --include="*.hpp" --include="*.h" | wc -l || echo "0")
        FIXME_COUNT=$(grep -r "FIXME" magda/ tests/ --include="*.cpp" --include="*.hpp" --include="*.h" | wc -l || echo "0")
        
        echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
        echo "fixme_count=$FIXME_COUNT" >> $GITHUB_OUTPUT
        
        echo "" >> analysis-report.txt
        echo "=== Summary ===" >> analysis-report.txt
        echo "TODOs found: $TODO_COUNT" >> analysis-report.txt
        echo "FIXMEs found: $FIXME_COUNT" >> analysis-report.txt

    - name: Find potential code smells
      run: |
        echo "" >> analysis-report.txt
        echo "=== Potential Code Smells ===" >> analysis-report.txt
        
        # Find long functions (simplified heuristic - files with long blocks)
        echo "Large implementation files (may contain long functions):" >> analysis-report.txt
        find magda/ tests/ \( -name "*.cpp" -o -name "*.hpp" \) | while read -r file; do
          LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
          if [ "$LINES" -gt 300 ]; then
            echo "$file: $LINES lines" >> analysis-report.txt
          fi
        done || true
        
        # Find files with many includes (potential dependency issues)
        echo "" >> analysis-report.txt
        echo "Files with many includes (>15):" >> analysis-report.txt
        find magda/ tests/ \( -name "*.cpp" -o -name "*.hpp" \) | while read -r file; do
          INCLUDE_COUNT=$(grep -c "^#include" "$file" || echo "0")
          if [ "$INCLUDE_COUNT" -gt 15 ]; then
            echo "$file: $INCLUDE_COUNT includes" >> analysis-report.txt
          fi
        done

    - name: Check for common anti-patterns
      run: |
        echo "" >> analysis-report.txt
        echo "=== Potential Anti-Patterns ===" >> analysis-report.txt
        
        # Find potential memory leaks (new without corresponding delete/unique_ptr)
        echo "Files with raw 'new' (consider using smart pointers):" >> analysis-report.txt
        grep -r "\bnew\b" magda/ tests/ --include="*.cpp" --include="*.hpp" -l | head -20 >> analysis-report.txt || true
        
        # Find potential thread safety issues (mutable static variables)
        echo "" >> analysis-report.txt
        echo "Static non-const variables (potential thread safety issues):" >> analysis-report.txt
        grep -r "static.*[^const].*=" magda/ tests/ --include="*.cpp" --include="*.hpp" -n | grep -v "const" | head -20 >> analysis-report.txt || true

    - name: Upload analysis report
      uses: actions/upload-artifact@v4
      with:
        name: code-analysis-report
        path: |
          analysis-report.txt
          cloc-report.json
        retention-days: 30

    - name: Create issue for high-priority findings
      if: steps.metrics.outputs.fixme_count > 5
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('analysis-report.txt', 'utf8');
          
          const issueBody = `## Automated Code Analysis Report
          
          This issue was automatically created by the periodic code analysis workflow.
          
          ### Summary
          - **FIXMEs found**: ${{ steps.metrics.outputs.fixme_count }}
          - **TODOs found**: ${{ steps.metrics.outputs.todo_count }}
          
          ### Details
          
          <details>
          <summary>Full Analysis Report</summary>
          
          \`\`\`
          ${report}
          \`\`\`
          
          </details>
          
          ### Recommendations
          
          1. Review and address high-priority FIXMEs
          2. Consider creating separate issues for larger TODOs
          3. Refactor long functions for better maintainability
          4. Review files with many dependencies for potential simplification
          
          **Note**: This is an automated report. Please review findings for false positives.
          `;
          
          // Check if a similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['automated-analysis'],
            state: 'open'
          });
          
          if (issues.data.length === 0) {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Automated] Code Analysis Report - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['automated-analysis', 'code-quality']
            });
            console.log('Created new analysis issue');
          } else {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `## Updated Analysis - ${new Date().toISOString()}\n\n${issueBody}`
            });
            console.log('Updated existing analysis issue');
          }

    - name: Summary
      run: |
        echo "## Analysis Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **TODOs**: ${{ steps.metrics.outputs.todo_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **FIXMEs**: ${{ steps.metrics.outputs.fixme_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full report available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
